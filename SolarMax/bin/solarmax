#!/usr/bin/python
# -* coding: utf-8 *-

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Developed 2009-2010 by Bernd Wurst <bernd@schokokeks.org> 
# for own use.
# Released to the public in 2012.

# Array of inverters in system. IP address and device number
inverters = { '192.168.1.123': [1,]}


smlist = []
for host in inverters.keys():
  sm = SolarMax(host, 12345)
  sm.use_inverters(inverters[host])
  smlist.append(sm)


allinverters = []
for host in inverters.keys():
  allinverters.extend(inverters[host])

while True:
  pac_gesamt = 0.0
  daysum_gesamt = 0.0

  count = 0
  for sm in smlist:
    for (no, ivdata) in sm.inverters().iteritems():
      try:
        (inverter, current) = sm.query(no, ['PAC', 'KDY', 'KT0', 'IDC', 'UDC', 'IL1', 'UL1', 'FDAT', 'SYS'])
        count += 1
      except:
        # Kommunikationsfehler, evtl. Wechselrichter aus
        print 'Communication Error, WR %i' % no
        continue
    
      ivmax = ivdata['installed']
      ivname = ivdata['desc']
      PAC = current['IL1'] * current['UL1']
      percent = int((PAC/ivmax) * 100)
      PDC = current['IDC'] * current['UDC']
      (status, errors) = sm.status(no)
      if errors:
        print 'WR %i: %s (%s)' % (no, status, errors)
      
      try:
        # KÃ¶nnte gelocked sein
        # System ist 2 in diesem Fall. Fix.
        print("PAC = "+str(PAC))
      except:
        pass

  if count < len(allinverters):
    print 'Too little inverter (%i < %i)' % (count, len(allinverters))

  #print '='*80
  #print 'GESAMT:  %9.2f Watt    / Heute: %8.1f kWh' % (pac_gesamt, daysum_gesamt)
  time.sleep(10)








